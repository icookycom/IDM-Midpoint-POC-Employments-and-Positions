<apti:object xmlns:apti="http://midpoint.evolveum.com/xml/ns/public/common/api-types-3" xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3" xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3" xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3" xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3" xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3" xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3" xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" oid="7656e85c-0652-4a1a-839f-b823a8d7c246" version="112"  xsi:type="c:RoleType">
        <_metadata id="1">
            <storage>
                <createTimestamp>2025-03-26T07:07:48.463Z</createTimestamp>
                <creatorRef>
                    <t:oid>00000000-0000-0000-0000-000000000002</t:oid>
                    <t:relation xmlns="http://prism.evolveum.com/xml/ns/public/types-3">org:default</t:relation>
                    <t:type xmlns="http://prism.evolveum.com/xml/ns/public/types-3">c:UserType</t:type>
                </creatorRef>
                <createChannel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</createChannel>
                <modifyTimestamp>2025-05-23T04:03:39.242Z</modifyTimestamp>
                <modifierRef>
                    <t:oid>00000000-0000-0000-0000-000000000002</t:oid>
                    <t:relation xmlns="http://prism.evolveum.com/xml/ns/public/types-3">org:default</t:relation>
                    <t:type xmlns="http://prism.evolveum.com/xml/ns/public/types-3">c:UserType</t:type>
                </modifierRef>
                <modifyChannel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</modifyChannel>
            </storage>
            <process>
                <requestTimestamp>2025-03-31T08:11:54.347Z</requestTimestamp>
                <requestorRef>
                    <t:oid>00000000-0000-0000-0000-000000000002</t:oid>
                    <t:relation xmlns="http://prism.evolveum.com/xml/ns/public/types-3">org:default</t:relation>
                    <t:type xmlns="http://prism.evolveum.com/xml/ns/public/types-3">c:UserType</t:type>
                </requestorRef>
            </process>
        </_metadata>
        <name>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</name>
        <description>Assiment of User to Role from extension\user_personalNumber</description>
        <extension/>
        <lifecycleState>archived</lifecycleState>
        <operationExecution id="60">
            <recordType>simple</recordType>
            <timestamp>2025-04-17T07:57:32.056Z</timestamp>
            <operation>
                <objectDelta>
                    <t:changeType>modify</t:changeType>
                    <t:objectType>c:RoleType</t:objectType>
                </objectDelta>
                <executionResult>
                    <operation>com.evolveum.midpoint.model.impl.lens.ChangeExecutor.executeDelta</operation>
                    <status>success</status>
                    <importance>normal</importance>
                    <token>1000000000000203307</token>
                </executionResult>
                <objectName>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</objectName>
            </operation>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="62">
            <recordType>simple</recordType>
            <timestamp>2025-04-17T07:59:04.688Z</timestamp>
            <operation>
                <objectDelta>
                    <t:changeType>modify</t:changeType>
                    <t:objectType>c:RoleType</t:objectType>
                </objectDelta>
                <executionResult>
                    <operation>com.evolveum.midpoint.model.impl.lens.ChangeExecutor.executeDelta</operation>
                    <status>success</status>
                    <importance>normal</importance>
                    <token>1000000000000205377</token>
                </executionResult>
                <objectName>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</objectName>
            </operation>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="65">
            <recordType>simple</recordType>
            <timestamp>2025-04-17T10:35:24.851Z</timestamp>
            <operation>
                <objectDelta>
                    <t:changeType>modify</t:changeType>
                    <t:objectType>c:RoleType</t:objectType>
                </objectDelta>
                <executionResult>
                    <operation>com.evolveum.midpoint.model.impl.lens.ChangeExecutor.executeDelta</operation>
                    <status>success</status>
                    <importance>normal</importance>
                    <token>1000000000000372276</token>
                </executionResult>
                <objectName>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</objectName>
            </operation>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="82">
            <recordType>simple</recordType>
            <timestamp>2025-04-17T13:33:51.715Z</timestamp>
            <operation>
                <objectDelta>
                    <t:changeType>modify</t:changeType>
                    <t:objectType>c:RoleType</t:objectType>
                </objectDelta>
                <executionResult>
                    <operation>com.evolveum.midpoint.model.impl.lens.ChangeExecutor.executeDelta</operation>
                    <status>success</status>
                    <importance>normal</importance>
                    <token>1000000000000011502</token>
                </executionResult>
                <objectName>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</objectName>
            </operation>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="87">
            <recordType>complex</recordType>
            <timestamp>2025-05-13T08:48:08.890Z</timestamp>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <taskRef oid="ea939731-75b9-4887-9069-59266fd2ec03" relation="org:default" type="c:TaskType"/>
            <activityPath/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="88">
            <recordType>complex</recordType>
            <timestamp>2025-05-13T08:52:43.228Z</timestamp>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <taskRef oid="5d387239-1e04-4f3b-8a08-0532c77f08fb" relation="org:default" type="c:TaskType"/>
            <activityPath/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="89">
            <recordType>complex</recordType>
            <timestamp>2025-05-22T15:29:00.947Z</timestamp>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <taskRef oid="b762dd06-578b-45a0-9f85-f4e624491d7b" relation="org:default" type="c:TaskType"/>
            <activityPath/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="90">
            <recordType>complex</recordType>
            <timestamp>2025-05-23T03:58:45.518Z</timestamp>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <taskRef oid="8f876e05-64ea-4cf6-aa97-376b6472f826" relation="org:default" type="c:TaskType"/>
            <activityPath/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="91">
            <recordType>simple</recordType>
            <timestamp>2025-05-23T04:03:39.267Z</timestamp>
            <operation>
                <objectDelta>
                    <t:changeType>modify</t:changeType>
                    <t:objectType>c:RoleType</t:objectType>
                </objectDelta>
                <executionResult>
                    <operation>com.evolveum.midpoint.model.impl.lens.ChangeExecutor.executeDelta</operation>
                    <status>success</status>
                    <importance>normal</importance>
                    <token>1000000000000005072</token>
                </executionResult>
                <objectName>POCE POLICY: Assiment of User to Role from extension\user_personalNumber</objectName>
            </operation>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <operationExecution id="92">
            <recordType>complex</recordType>
            <timestamp>2025-05-23T09:05:18.316Z</timestamp>
            <status>success</status>
            <initiatorRef oid="00000000-0000-0000-0000-000000000002" relation="org:default" type="c:UserType"/>
            <taskRef oid="1333d492-e976-4f11-85c4-1dc17d598c08" relation="org:default" type="c:TaskType"/>
            <activityPath/>
            <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
        </operationExecution>
        <assignment incomplete="true"/>
        <iteration>0</iteration>
        <iterationToken/>
        <activation>
            <effectiveStatus>disabled</effectiveStatus>
            <disableTimestamp>2025-05-23T04:03:39.204Z</disableTimestamp>
            <enableTimestamp>2025-03-31T08:11:54.381Z</enableTimestamp>
        </activation>
        <inducement id="9">
            <_metadata id="8">
                <storage>
                    <modifyTimestamp>2025-03-31T07:46:02.350Z</modifyTimestamp>
                    <modifierRef>
                        <t:oid>00000000-0000-0000-0000-000000000002</t:oid>
                        <t:relation xmlns="http://prism.evolveum.com/xml/ns/public/types-3">org:default</t:relation>
                        <t:type xmlns="http://prism.evolveum.com/xml/ns/public/types-3">c:UserType</t:type>
                    </modifierRef>
                    <modifyChannel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</modifyChannel>
                </storage>
            </_metadata>
            <policyRule>
                <name>Assiment of a User to Role</name>
                <policyConstraints>
                    <modification id="78">
                        <name>add</name>
                        <operation>add</operation>
                        <item>c:emailAddress</item>
                    </modification>
                </policyConstraints>
                <policyActions>
                    <scriptExecution id="11">
                        <name>Some script</name>
                        <condition>
                            <script>
                                <code>basic.isEmpty(focus?.getEmailAddress())</code>
                            </script>
                        </condition>
                        <object>
                            <currentObject>
                                <type>c:RoleType</type>
                            </currentObject>
                        </object>
                        <executeScript xmlns:s="http://midpoint.evolveum.com/xml/ns/public/model/scripting-3">
                            <_metadata id="63">
                                <provenance>
                                    <acquisition id="64">
                                        <actorRef>
                                            <t:oid>00000000-0000-0000-0000-000000000002</t:oid>
                                            <t:relation xmlns="http://prism.evolveum.com/xml/ns/public/types-3">org:default</t:relation>
                                            <t:type xmlns="http://prism.evolveum.com/xml/ns/public/types-3">c:UserType</t:type>
                                        </actorRef>
                                        <channel>http://midpoint.evolveum.com/xml/ns/public/common/channels-3#user</channel>
                                        <timestamp>2025-04-17T10:35:24.754Z</timestamp>
                                    </acquisition>
                                </provenance>
                            </_metadata>
                            <s:pipeline list="true">
                                <s:action>
                                    <s:type>execute-script</s:type>
                                    <s:parameter>
                                        <s:name>script</s:name>
                                        <s:value>
                                            <code>
import com.evolveum.midpoint.xml.ns._public.common.common_3.*
import com.evolveum.midpoint.prism.delta.builder.*
import com.evolveum.midpoint.model.api.*
log.info " AAAAAAAAAAAAAAA: a try"

role = midpoint.getObject(RoleType.class, input.oid)
userId = basic.stringify(basic.getExtensionPropertyValue(role, "http://example.com/xml/ns/mySchema", "user_personalNumber"))
query_user = midpoint.queryFor(UserType.class, "personalNumber = '$userId' and archetypeRef matches (oid = '00000000-0000-0000-0000-000000000702')") 
result_USER = midpoint.searchObjects(query_user)



if (result_USER)
{
user_oid = basic.stringify(result_USER.oid)
user = midpoint.getObject(UserType.class, user_oid)
assRole = new ObjectReferenceType()
assRole.setOid(input.oid)
assRole.setType(RoleType.COMPLEX_TYPE)
addAssignment = new AssignmentType()
addAssignment.setTargetRef(assRole)
def delta = []
delta = prismContext.deltaFor(UserType.class).item(FocusType.F_ASSIGNMENT).add(addAssignment.asPrismContainerValue()).asObjectDelta(user.oid)
midpoint.modifyObject(delta, ModelExecuteOptions.createRaw())
}    

midpoint.recompute(UserType, user.oid)
midpoint.recompute(RoleType, input.oid)

</code>
                                        </s:value>
                                    </s:parameter>
                                </s:action>
                            </s:pipeline>
                        </executeScript>
                        <privileges>
                            <runPrivileged>true</runPrivileged>
                        </privileges>
                    </scriptExecution>
                </policyActions>
            </policyRule>
            <activation/>
            <focusType>c:RoleType</focusType>
        </inducement>
    </apti:object>
